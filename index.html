<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f14">
<link rel="manifest" href="manifest.json">
<title>Dutch B1 Tracker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');

:root {
  --bg: #0f0f14;
  --bg2: #16161e;
  --bg3: #1e1e28;
  --bg4: #282836;
  --text: #e8e6e3;
  --text2: #9a9a9a;
  --text3: #5a5a6a;
  --amber: #e8a020;
  --amber2: #c88a10;
  --amber-glow: rgba(232, 160, 32, 0.15);
  --teal: #2dd4a8;
  --teal-dim: rgba(45, 212, 168, 0.15);
  --red: #f04060;
  --red-dim: rgba(240, 64, 96, 0.1);
  --blue: #4090f0;
  --blue-dim: rgba(64, 144, 240, 0.15);
  --purple: #a070f0;
  --purple-dim: rgba(160, 112, 240, 0.15);
  --radius: 14px;
  --radius-sm: 8px;
  --nav-height: 72px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

.light-mode {
  --bg: #f4f2ef;
  --bg2: #ffffff;
  --bg3: #eae8e4;
  --bg4: #ddd;
  --text: #1a1a1a;
  --text2: #666;
  --text3: #aaa;
  --amber-glow: rgba(232, 160, 32, 0.1);
  --teal-dim: rgba(45, 212, 168, 0.1);
  --red-dim: rgba(240, 64, 96, 0.06);
  --blue-dim: rgba(64, 144, 240, 0.1);
  --purple-dim: rgba(160, 112, 240, 0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'DM Sans', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  overscroll-behavior: none;
  -webkit-font-smoothing: antialiased;
}

.app {
  height: 100vh;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  max-width: 480px;
  margin: 0 auto;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  padding: calc(12px + var(--safe-top)) 20px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}
.header h1 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 700;
  color: var(--amber);
  letter-spacing: -0.5px;
}
.header-right { display: flex; gap: 8px; align-items: center; }
.theme-btn {
  background: none; border: none; color: var(--text2);
  font-size: 20px; cursor: pointer; padding: 6px;
  border-radius: 8px; transition: background 0.2s;
}
.theme-btn:active { background: var(--bg3); }

/* ‚îÄ‚îÄ Content Area ‚îÄ‚îÄ */
.content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 16px 16px;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
}

/* ‚îÄ‚îÄ Tab Views ‚îÄ‚îÄ */
.view { display: none; }
.view.active { display: block; }

/* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
.nav {
  display: flex;
  background: var(--bg2);
  border-top: 1px solid var(--bg4);
  padding: 6px 8px calc(6px + var(--safe-bottom));
  flex-shrink: 0;
  gap: 4px;
}
.nav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 8px 4px 6px;
  border: none;
  background: none;
  color: var(--text3);
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.2s;
  font-family: 'DM Sans', system-ui;
}
.nav-btn .icon { font-size: 22px; line-height: 1; }
.nav-btn.active { color: var(--amber); background: var(--amber-glow); }
.nav-btn:active { transform: scale(0.92); }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--bg3);
}
.card-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  margin-bottom: 10px;
}

/* ‚îÄ‚îÄ Stats Row ‚îÄ‚îÄ */
.stats-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}
.stat-box {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius-sm);
  padding: 12px 10px;
  text-align: center;
}
.stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 24px;
  font-weight: 700;
  line-height: 1;
}
.stat-label {
  font-size: 10px;
  color: var(--text2);
  margin-top: 4px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ‚îÄ‚îÄ Skill Bars ‚îÄ‚îÄ */
.skill-bar-wrap { margin-bottom: 10px; }
.skill-bar-wrap:last-child { margin-bottom: 0; }
.skill-bar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}
.skill-bar-name {
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.skill-bar-name .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}
.skill-bar-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text2);
}
.skill-bar-track {
  height: 8px;
  background: var(--bg4);
  border-radius: 4px;
  overflow: hidden;
}
.skill-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
  min-width: 2px;
}

/* ‚îÄ‚îÄ Quick Log ‚îÄ‚îÄ */
.log-section { margin-bottom: 16px; }
.log-section-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
/* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
.timer-display {
  font-family: 'JetBrains Mono', monospace;
  font-size: 48px;
  font-weight: 700;
  text-align: center;
  color: var(--text);
  padding: 20px 0 16px;
  letter-spacing: 2px;
}
.timer-display.running { color: var(--teal); }
.timer-display.paused { color: var(--amber); }
.timer-controls {
  display: flex;
  gap: 8px;
  justify-content: center;
}
.timer-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'DM Sans', system-ui;
  transition: transform 0.15s;
}
.timer-btn:active { transform: scale(0.95); }
.timer-btn.start { background: var(--teal); color: #000; }
.timer-btn.pause { background: var(--amber); color: #000; }
.timer-btn.stop { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
.timer-btn.save { flex: 1; background: var(--teal); color: #000; }
.timer-btn.discard { flex: 1; background: var(--bg3); color: var(--text2); }
.timer-save-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--bg3);
}

/* ‚îÄ‚îÄ Video Calculator ‚îÄ‚îÄ */
.calc-total {
  text-align: center;
  padding: 12px 0;
}
.calc-total-label {
  font-size: 13px;
  color: var(--text2);
}
.calc-total-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 36px;
  font-weight: 700;
  color: var(--amber);
  margin: 0 6px;
}
.calc-total-unit {
  font-size: 13px;
  color: var(--text2);
}
.calc-entries {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
  min-height: 0;
}
.calc-entry {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: 20px;
  padding: 4px 10px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text2);
}
.calc-entry-remove {
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 14px;
  padding: 0 2px;
  line-height: 1;
}
.calc-entry-remove:hover { color: var(--red); }
.calc-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}
.calc-input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: 8px;
  padding: 12px;
  color: var(--text);
  font-size: 16px;
  font-family: 'JetBrains Mono', monospace;
  outline: none;
}
.calc-input:focus { border-color: var(--amber); }
.calc-add-btn {
  width: 48px;
  background: var(--amber);
  color: #000;
  border: none;
  border-radius: 8px;
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
}
.calc-add-btn:active { transform: scale(0.93); }
.calc-minus-btn {
  width: 48px;
  background: var(--red-dim);
  color: var(--red);
  border: 1px solid color-mix(in oklab, var(--red), transparent 40%);
  border-radius: 8px;
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
}
.calc-minus-btn:active { transform: scale(0.93); }
.calc-actions {
  display: flex;
  gap: 8px;
}

/* ‚îÄ‚îÄ Total Hours Overview ‚îÄ‚îÄ */
.total-hours-card {
  text-align: center;
  padding: 20px 16px;
  background: linear-gradient(135deg, var(--bg3), var(--bg2));
  border: 1px solid var(--amber);
}
.total-hours-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 44px;
  font-weight: 700;
  color: var(--amber);
  line-height: 1;
}
.total-hours-label {
  font-size: 13px;
  color: var(--text2);
  margin-top: 6px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ‚îÄ‚îÄ B1 Goal Tracker ‚îÄ‚îÄ */
.b1-goal-stats {
  text-align: center;
  margin-bottom: 12px;
}
.b1-goal-current {
  font-family: 'JetBrains Mono', monospace;
  font-size: 32px;
  font-weight: 700;
  color: var(--amber);
}
.b1-goal-separator {
  font-size: 20px;
  color: var(--text3);
  margin: 0 4px;
}
.b1-goal-target {
  font-family: 'JetBrains Mono', monospace;
  font-size: 20px;
  font-weight: 600;
  color: var(--text2);
}
.b1-goal-unit {
  font-size: 13px;
  color: var(--text3);
  margin-left: 4px;
}
.b1-progress-track {
  height: 12px;
  background: var(--bg4);
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 10px;
}
.b1-progress-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 0.6s ease, background 0.3s ease;
  min-width: 0;
}
.b1-goal-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.b1-goal-pct {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px;
  font-weight: 700;
}
.b1-goal-remaining {
  font-size: 12px;
  color: var(--text2);
}

/* ‚îÄ‚îÄ Delete Entry / History ‚îÄ‚îÄ */
.history-entry {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--bg3);
}
.history-entry:last-child { border: none; }
.history-entry-info {
  flex: 1;
  min-width: 0;
}
.history-entry-skill {
  font-size: 13px;
  font-weight: 600;
}
.history-entry-meta {
  font-size: 11px;
  color: var(--text3);
  margin-top: 2px;
}
.history-entry-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  color: var(--amber);
  margin-right: 10px;
  flex-shrink: 0;
}
.history-delete-btn {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 18px;
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  transition: all 0.15s;
  flex-shrink: 0;
}
.history-delete-btn:active {
  background: var(--red-dim);
  color: var(--red);
}
.history-day-header {
  font-size: 13px;
  font-weight: 700;
  color: var(--text2);
  padding: 10px 0 4px;
  border-bottom: 1px solid var(--bg4);
  margin-top: 6px;
}
.history-day-header:first-child { margin-top: 0; }

/* ‚îÄ‚îÄ Custom Input Modal ‚îÄ‚îÄ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 100;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--bg2);
  border-radius: 20px 20px 0 0;
  padding: 24px 20px calc(24px + var(--safe-bottom));
  width: 100%;
  max-width: 480px;
  animation: slideUp 0.25s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
}
.modal-input {
  width: 100%;
  background: var(--bg3);
  border: 2px solid var(--bg4);
  border-radius: 10px;
  padding: 14px;
  color: var(--text);
  font-size: 18px;
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 12px;
  outline: none;
}
.modal-input:focus { border-color: var(--amber); }
.modal-btns { display: flex; gap: 8px; }
.modal-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'DM Sans', system-ui;
}
.modal-btn.cancel { background: var(--bg3); color: var(--text2); }
.modal-btn.confirm { background: var(--amber); color: #000; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: fixed;
  top: calc(16px + var(--safe-top));
  left: 50%;
  transform: translateX(-50%) translateY(-120%);
  background: var(--teal);
  color: #000;
  padding: 10px 20px;
  border-radius: 30px;
  font-size: 13px;
  font-weight: 600;
  z-index: 200;
  transition: transform 0.3s ease;
  white-space: nowrap;
  pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ History / Charts ‚îÄ‚îÄ */
.chart-container {
  height: 180px;
  position: relative;
  margin: 8px 0;
}
.chart-canvas { width: 100%; height: 100%; }

.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--bg3);
}
.history-item:last-child { border: none; }
.history-date { font-size: 13px; font-weight: 600; }
.history-hours {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  color: var(--amber);
}

/* ‚îÄ‚îÄ Period Selector ‚îÄ‚îÄ */
.period-selector {
  display: flex;
  background: var(--bg3);
  border-radius: 10px;
  padding: 3px;
  margin-bottom: 14px;
}
.period-btn {
  flex: 1;
  padding: 8px;
  border: none;
  background: none;
  color: var(--text2);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s;
  font-family: 'DM Sans', system-ui;
}
.period-btn.active {
  background: var(--bg2);
  color: var(--text);
}

/* ‚îÄ‚îÄ Anki Section ‚îÄ‚îÄ */
.anki-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.anki-field label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.anki-field input {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: 8px;
  padding: 12px;
  color: var(--text);
  font-size: 16px;
  font-family: 'JetBrains Mono', monospace;
  outline: none;
}
.anki-field input:focus { border-color: var(--amber); }
.anki-save-btn {
  width: 100%;
  margin-top: 10px;
  padding: 14px;
  background: var(--teal);
  color: #000;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'DM Sans', system-ui;
}
.anki-save-btn:active { transform: scale(0.97); }

/* ‚îÄ‚îÄ Settings ‚îÄ‚îÄ */
.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 0;
  border-bottom: 1px solid var(--bg3);
}
.setting-row:last-child { border: none; }
.setting-label { font-size: 14px; font-weight: 500; }
.setting-desc { font-size: 11px; color: var(--text3); margin-top: 2px; }
.toggle {
  width: 48px; height: 28px;
  background: var(--bg4);
  border-radius: 14px;
  border: none;
  cursor: pointer;
  position: relative;
  transition: background 0.2s;
}
.toggle.on { background: var(--amber); }
.toggle::after {
  content: '';
  position: absolute;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: white;
  top: 3px; left: 3px;
  transition: transform 0.2s;
}
.toggle.on::after { transform: translateX(20px); }

.danger-btn {
  width: 100%;
  padding: 14px;
  background: var(--red-dim);
  color: var(--red);
  border: 1px solid var(--red);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 12px;
  font-family: 'DM Sans', system-ui;
}
.danger-btn:active { opacity: 0.7; }

/* ‚îÄ‚îÄ Undo Bar ‚îÄ‚îÄ */
.undo-bar {
  position: fixed;
  bottom: calc(var(--nav-height) + 12px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%) translateY(120px);
  background: var(--bg3);
  border: 1px solid var(--bg4);
  padding: 10px 16px;
  border-radius: 30px;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 50;
  transition: transform 0.3s ease;
  font-size: 13px;
  white-space: nowrap;
}
.undo-bar.show { transform: translateX(-50%) translateY(0); }
.undo-btn {
  background: var(--amber);
  color: #000;
  border: none;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'DM Sans', system-ui;
}

/* ‚îÄ‚îÄ Week Heatmap ‚îÄ‚îÄ */
.week-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 4px;
  margin-top: 8px;
}
.week-cell {
  aspect-ratio: auto;
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  background: var(--bg3);
}
.week-cell .day-name { color: var(--text3); font-size: 9px; }
.week-cell .day-hours {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  margin-top: 1px;
}
.week-cell.good { background: var(--teal-dim); }
.week-cell.good .day-hours { color: var(--teal); }
.week-cell.mid { background: var(--amber-glow); }
.week-cell.mid .day-hours { color: var(--amber); }
.week-cell.low { background: var(--red-dim); }
.week-cell.low .day-hours { color: var(--red); }
.week-cell.empty .day-hours { color: var(--text3); }
.week-cell.today { border: 2px solid var(--amber); }

/* ‚îÄ‚îÄ Scroll ‚îÄ‚îÄ */
.content::-webkit-scrollbar { width: 0; }

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
.card { animation: fadeIn 0.3s ease; }

/* ‚îÄ‚îÄ Goal Progress ‚îÄ‚îÄ */
.goal-card {
  display: flex;
  align-items: center;
  gap: 16px;
}
.goal-ring-wrap {
  position: relative;
  width: 80px;
  height: 80px;
  flex-shrink: 0;
}
.goal-ring-wrap svg {
  width: 80px;
  height: 80px;
  transform: rotate(-90deg);
}
.goal-ring-wrap .ring-bg {
  fill: none;
  stroke: var(--bg4);
  stroke-width: 6;
}
.goal-ring-wrap .ring-fill {
  fill: none;
  stroke-width: 6;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.6s ease;
}
.goal-center {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.goal-center .goal-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 700;
  line-height: 1;
}
.goal-center .goal-of {
  font-size: 10px;
  color: var(--text3);
  margin-top: 2px;
}
.goal-details { flex: 1; }
.goal-details .goal-pct {
  font-family: 'JetBrains Mono', monospace;
  font-size: 22px;
  font-weight: 700;
  color: var(--amber);
}
.goal-details .goal-msg {
  font-size: 12px;
  color: var(--text2);
  margin-top: 2px;
}
.goal-details .goal-left {
  font-size: 11px;
  color: var(--text3);
  margin-top: 5px;
  font-family: 'JetBrains Mono', monospace;
}

/* ‚îÄ‚îÄ Manual Entry ‚îÄ‚îÄ */
.manual-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.manual-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.manual-field label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.manual-field input,
.manual-field select,
.manual-field textarea {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: 8px;
  padding: 12px;
  color: var(--text);
  font-size: 14px;
  font-family: 'JetBrains Mono', monospace;
  outline: none;
}
.manual-field select {
  appearance: none;
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239a9a9a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}
.manual-field textarea {
  font-family: 'DM Sans', system-ui;
  font-size: 13px;
  resize: none;
  height: 60px;
}
.manual-field input:focus,
.manual-field select:focus,
.manual-field textarea:focus { border-color: var(--amber); }

/* ‚îÄ‚îÄ Tags ‚îÄ‚îÄ */
.tag-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
}
.tag-pill {
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid var(--bg4);
  background: var(--bg3);
  color: var(--text2);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'DM Sans', system-ui;
  -webkit-user-select: none;
  user-select: none;
}
.tag-pill.selected {
  background: var(--amber-glow);
  border-color: var(--amber);
  color: var(--amber);
}
.tag-pill:active { transform: scale(0.94); }
.save-manual-btn {
  width: 100%;
  padding: 14px;
  background: var(--teal);
  color: #000;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'DM Sans', system-ui;
}
.save-manual-btn:active { transform: scale(0.97); }

/* ‚îÄ‚îÄ Goal Cards (new system) ‚îÄ‚îÄ */
.goal-card-new {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
}
.goal-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.goal-card-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.goal-card-actions {
  display: flex;
  gap: 4px;
}
.goal-card-actions button {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
}
.goal-card-actions button:active { color: var(--text); }
.goal-metric {
  margin-bottom: 8px;
}
.goal-metric:last-child { margin-bottom: 0; }
.goal-metric-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 4px;
}
.goal-metric-label {
  font-size: 12px;
  color: var(--text2);
}
.goal-metric-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  font-weight: 600;
}
.goal-progress-track {
  height: 8px;
  background: var(--bg4);
  border-radius: 4px;
  overflow: hidden;
}
.goal-progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}
.goal-pace {
  font-size: 11px;
  color: var(--text3);
  margin-top: 6px;
  font-family: 'JetBrains Mono', monospace;
}
.goal-milestone {
  font-size: 11px;
  color: var(--text3);
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.goal-milestone.reached { color: var(--teal); }
.goal-streak-display {
  text-align: center;
  padding: 8px 0;
}
.goal-streak-number {
  font-family: 'JetBrains Mono', monospace;
  font-size: 36px;
  font-weight: 700;
  line-height: 1;
}
.goal-streak-label {
  font-size: 12px;
  color: var(--text2);
  margin-top: 4px;
}
.milestone-field {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-top: 6px;
}
.milestone-field input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: 6px;
  padding: 8px;
  color: var(--text);
  font-size: 13px;
  font-family: 'JetBrains Mono', monospace;
  outline: none;
}
.milestone-field input:focus { border-color: var(--amber); }
.milestone-remove {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
}
.milestone-remove:hover { color: var(--red); }
.week-total {
  text-align: center;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--bg3);
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  color: var(--amber);
  font-weight: 600;
}
.skill-total {
  text-align: right;
  margin-top: 8px;
  padding-top: 6px;
  border-top: 1px solid var(--bg3);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  color: var(--text2);
}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Header -->
  <div class="header">
    <h1>NL_TRACKER</h1>
    <div class="header-right">
      <button class="theme-btn" id="themeToggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
    <div class="view active" id="viewDashboard">
      <!-- Today's Stats -->
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-value" id="todayHours" style="color:var(--amber)">0.0</div>
          <div class="stat-label">Uren</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="todayAnki" style="color:var(--teal)">0</div>
          <div class="stat-label">Anki</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="streakCount" style="color:var(--red)">0</div>
          <div class="stat-label">Streak üî•</div>
        </div>
      </div>

      <!-- Total Study Hours -->
      <div class="card total-hours-card">
        <div class="total-hours-value" id="totalStudyHours">0.00</div>
        <div class="total-hours-label">Totale studie-uren</div>
      </div>

      <!-- Goals Section -->
      <div id="goalsSection"></div>
      <div style="text-align:center;margin-bottom:12px">
        <button onclick="openGoalModal()" style="background:var(--bg2);border:1px dashed var(--bg4);border-radius:var(--radius);padding:12px;width:100%;color:var(--text3);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',system-ui">+ Nieuw doel</button>
      </div>

      <!-- Daily Goal Progress -->
      <div class="card">
        <div class="card-title">Dagelijks doel</div>
        <div class="goal-card">
          <div class="goal-ring-wrap">
            <svg viewBox="0 0 80 80">
              <circle class="ring-bg" cx="40" cy="40" r="34"/>
              <circle class="ring-fill" id="goalRing" cx="40" cy="40" r="34"
                stroke="var(--amber)" stroke-dasharray="213.6" stroke-dashoffset="213.6"/>
            </svg>
            <div class="goal-center">
              <span class="goal-val" id="goalCurrent">0.0</span>
              <span class="goal-of" id="dailyGoalDisplay">/ 2.0u</span>
            </div>
          </div>
          <div class="goal-details">
            <div class="goal-pct" id="goalPct">0%</div>
            <div class="goal-msg" id="goalMsg">Begin met studeren!</div>
            <div class="goal-left" id="goalLeft"></div>
          </div>
        </div>
      </div>

      <!-- This Week Heatmap -->
      <div class="card">
        <div class="card-title">Deze week</div>
        <div id="weekGoalSummary"></div>
        <div class="week-grid" id="weekGrid"></div>
      </div>

      <!-- Cumulative Skills -->
      <div class="card">
        <div class="card-title">Totaal per vaardigheid</div>
        <div id="skillBarsTotal"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê QUICK LOG ‚ïê‚ïê‚ïê -->
    <div class="view" id="viewLog">
      <!-- Timer -->
      <div class="log-section">
        <div class="card" style="margin-bottom:0">
          <div class="card-title">Stopwatch</div>
          <div class="timer-display" id="timerDisplay">00:00:00</div>
          <div class="timer-controls">
            <button class="timer-btn start" id="timerStartBtn" onclick="timerStart()">&#9654; Start</button>
            <button class="timer-btn pause" id="timerPauseBtn" onclick="timerPause()" style="display:none">&#9208; Pauze</button>
            <button class="timer-btn stop" id="timerStopBtn" onclick="timerStop()" style="display:none">&#9209; Stop</button>
          </div>
          <div class="timer-save-section" id="timerSaveSection" style="display:none">
            <div class="manual-field" style="margin-bottom:10px">
              <label>Vaardigheid</label>
              <select id="timerSkill" onchange="onTimerSkillChange()">
                <option value="listening">üéß Luisteren</option>
                <option value="reading">üìñ Lezen</option>
                <option value="writing">‚úçÔ∏è Schrijven</option>
                <option value="grammar">üìê Grammatica</option>
              </select>
            </div>
            <div class="manual-field" id="timerPassiveWrap" style="display:none;margin-bottom:10px">
              <label>Passief luisteren</label>
              <button class="toggle" id="timerPassiveToggle" onclick="toggleTimerPassive()"></button>
            </div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
              <span style="font-size:13px;color:var(--text2)">Tijd:</span>
              <span id="timerResultTime" style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--amber)">0 min</span>
            </div>
            <div style="display:flex;gap:8px">
              <button class="timer-btn discard" onclick="timerDiscard()">Annuleer</button>
              <button class="timer-btn save" onclick="timerSave()">Opslaan</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Video Length Calculator -->
      <div class="log-section">
        <div class="card" style="margin-bottom:0">
          <div class="card-title">Video calculator</div>
          <div class="calc-total">
            <span class="calc-total-label">Totaal:</span>
            <span class="calc-total-value" id="calcTotal">0.00</span>
            <span class="calc-total-unit">min</span>
          </div>
          <div class="calc-entries" id="calcEntries"></div>
          <div class="calc-input-row">
            <input type="number" class="calc-input" id="calcInput"
              placeholder="24.58" inputmode="decimal" step="any"
              onkeydown="if(event.key==='Enter')calcAdd()">
            <button class="calc-add-btn" onclick="calcAdd()">+</button>
            <button class="calc-minus-btn" onclick="calcSubtract()">‚àí</button>
          </div>
          <div class="calc-actions">
            <button class="timer-btn discard" onclick="calcClear()">Wissen</button>
            <button class="timer-btn save" onclick="calcTransfer()">&#8594; Minuten veld</button>
          </div>
        </div>
      </div>

      <!-- Manual Entry -->
      <div class="log-section">
        <div class="card" style="margin-bottom:0">
          <div class="card-title">Handmatige invoer</div>
          <div class="manual-form">
            <div class="manual-row">
              <div class="manual-field">
                <label>Datum</label>
                <input type="date" id="manualDate">
              </div>
              <div class="manual-field">
                <label>Vaardigheid</label>
                <select id="manualSkill" onchange="onSkillChange()">
                  <option value="listening">üéß Luisteren</option>
                  <option value="reading">üìñ Lezen</option>
                  <option value="writing">‚úçÔ∏è Schrijven</option>
                  <option value="grammar">üìê Grammatica</option>
                </select>
              </div>
            </div>
            <div class="manual-row">
              <div class="manual-field">
                <label>Minuten</label>
                <input type="number" id="manualMinutes" placeholder="0" inputmode="numeric">
              </div>
              <div class="manual-field" id="passiveToggleWrap" style="display:none">
                <label>Passief luisteren</label>
                <button class="toggle" id="passiveToggle" onclick="togglePassive()"></button>
              </div>
            </div>
            <div class="manual-field">
              <label>Tags</label>
              <div class="tag-pills" id="manualTags">
                <span class="tag-pill" data-tag="podcast" onclick="toggleTag(this)">Podcast</span>
                <span class="tag-pill" data-tag="boek" onclick="toggleTag(this)">Boek</span>
                <span class="tag-pill" data-tag="artikel" onclick="toggleTag(this)">Artikel</span>
                <span class="tag-pill" data-tag="video" onclick="toggleTag(this)">Video</span>
                <span class="tag-pill" data-tag="gesprek" onclick="toggleTag(this)">Gesprek</span>
                <span class="tag-pill" data-tag="oefening" onclick="toggleTag(this)">Oefening</span>
                <span class="tag-pill" data-tag="cursus" onclick="toggleTag(this)">Cursus</span>
                <span class="tag-pill" data-tag="app" onclick="toggleTag(this)">App</span>
              </div>
            </div>
            <div class="manual-field">
              <label>Notities</label>
              <textarea id="manualNotes" placeholder="Optioneel..."></textarea>
            </div>
            <button class="save-manual-btn" onclick="saveManualEntry()">Opslaan</button>
          </div>
        </div>
      </div>

      <!-- Anki Log -->
      <div class="log-section">
        <div class="card" style="margin-bottom:0">
          <div class="card-title">Anki Kaarten</div>
          <div class="manual-row">
            <div class="manual-field">
              <label>Datum</label>
              <input type="date" id="ankiDate">
            </div>
            <div class="manual-field">
              <label>Kaarten herhaald</label>
              <input type="number" id="ankiCards" placeholder="0" inputmode="numeric">
            </div>
          </div>
          <button class="save-manual-btn" onclick="saveAnkiEntry()" style="margin-top:10px">Opslaan</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê -->
    <div class="view" id="viewStats">
      <div class="period-selector">
        <button class="period-btn active" onclick="setPeriod('week',this)">Week</button>
        <button class="period-btn" onclick="setPeriod('month',this)">Maand</button>
        <button class="period-btn" onclick="setPeriod('all',this)">Alles</button>
      </div>

      <!-- Tag Filter -->
      <div class="tag-pills" id="statsTagFilter" style="margin-bottom:12px"></div>

      <div class="card">
        <div class="card-title">Studietijd (uren/dag)</div>
        <div class="chart-container">
          <canvas id="hoursChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Vaardigheid verdeling</div>
        <div class="chart-container">
          <canvas id="skillChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Verdeling per tag</div>
        <div class="chart-container">
          <canvas id="tagChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Dagelijkse geschiedenis</div>
        <div id="historyList"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê -->
    <div class="view" id="viewSettings">
      <div class="card">
        <div class="card-title">Instellingen</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Donkere modus</div>
            <div class="setting-desc">Schakel tussen licht en donker</div>
          </div>
          <button class="toggle" id="darkToggle" onclick="toggleTheme()"></button>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Dagelijks doel (uren)</div>
            <div class="setting-desc">Standaard: 2 uur</div>
          </div>
          <input type="number" id="goalInput" value="2" min="0.5" max="8" step="0.5"
            style="width:60px;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;padding:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;text-align:center;outline:none;"
            onchange="updateGoal(this.value)">
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Dag verlengen na middernacht</div>
            <div class="setting-desc">Tot 03:00 als gisteren meetellen</div>
          </div>
          <button class="toggle" id="extendDayToggle" onclick="toggleExtendDay()"></button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Gegevens</div>
        <button class="danger-btn" onclick="exportData()">üì§ Gegevens exporteren (JSON)</button>
        <button class="danger-btn" style="background:var(--blue-dim);color:var(--blue);border-color:var(--blue);margin-top:8px" onclick="importData()">üì• Gegevens importeren</button>
        <button class="danger-btn" style="margin-top:8px" onclick="resetData()">‚ö†Ô∏è Alle gegevens wissen</button>
      </div>

      <div class="card">
        <div class="card-title">Installatie als app</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.6">
          <p style="margin-bottom:8px"><strong style="color:var(--text)">Android (Chrome):</strong><br>
          Menu (‚ãÆ) ‚Üí "Add to Home screen" / "Toevoegen aan startscherm"</p>
          <p style="margin-bottom:8px"><strong style="color:var(--text)">iPhone (Safari):</strong><br>
          Deel-knop (‚Üë) ‚Üí "Zet op beginscherm"</p>
          <p style="color:var(--text3);font-size:11px;margin-top:8px">
          De app werkt dan volledig offline, geen internet nodig.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button class="nav-btn active" onclick="switchTab('Dashboard',this)">
      <span class="icon">üìä</span>Overzicht
    </button>
    <button class="nav-btn" onclick="switchTab('Log',this)">
      <span class="icon">‚ö°</span>Loggen
    </button>
    <button class="nav-btn" onclick="switchTab('Stats',this)">
      <span class="icon">üìà</span>Stats
    </button>
    <button class="nav-btn" onclick="switchTab('Settings',this)">
      <span class="icon">‚öôÔ∏è</span>Meer
    </button>
  </nav>
</div>

<!-- Edit Entry Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h3>Invoer bewerken</h3>
    <input type="hidden" id="editEntryId">
    <div class="manual-form">
      <div class="manual-row">
        <div class="manual-field">
          <label>Datum</label>
          <input type="date" id="editDate">
        </div>
        <div class="manual-field">
          <label>Vaardigheid</label>
          <select id="editSkill" onchange="onEditSkillChange()">
            <option value="listening">Luisteren</option>
            <option value="reading">Lezen</option>
            <option value="writing">Schrijven</option>
            <option value="grammar">Grammatica</option>
          </select>
        </div>
      </div>
      <div class="manual-row">
        <div class="manual-field">
          <label>Minuten</label>
          <input type="number" id="editMinutes" placeholder="0" inputmode="numeric">
        </div>
        <div class="manual-field" id="editPassiveWrap" style="display:none">
          <label>Passief</label>
          <button class="toggle" id="editPassiveToggle" onclick="toggleEditPassive()"></button>
        </div>
      </div>
      <div class="manual-field">
        <label>Tags</label>
        <div class="tag-pills" id="editTags">
          <span class="tag-pill" data-tag="podcast" onclick="toggleTag(this)">Podcast</span>
          <span class="tag-pill" data-tag="boek" onclick="toggleTag(this)">Boek</span>
          <span class="tag-pill" data-tag="artikel" onclick="toggleTag(this)">Artikel</span>
          <span class="tag-pill" data-tag="video" onclick="toggleTag(this)">Video</span>
          <span class="tag-pill" data-tag="gesprek" onclick="toggleTag(this)">Gesprek</span>
          <span class="tag-pill" data-tag="oefening" onclick="toggleTag(this)">Oefening</span>
          <span class="tag-pill" data-tag="cursus" onclick="toggleTag(this)">Cursus</span>
          <span class="tag-pill" data-tag="app" onclick="toggleTag(this)">App</span>
        </div>
      </div>
      <div class="manual-field">
        <label>Notities</label>
        <textarea id="editNotes" placeholder="Optioneel..."></textarea>
      </div>
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="closeEditModal()">Annuleer</button>
        <button class="modal-btn confirm" onclick="saveEdit()">Opslaan</button>
      </div>
    </div>
  </div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" id="goalModal">
  <div class="modal" style="max-height:85vh;overflow-y:auto">
    <h3 id="goalModalTitle">Nieuw doel</h3>
    <input type="hidden" id="goalEditId">
    <div class="manual-form">
      <div class="manual-field">
        <label>Naam</label>
        <input type="text" id="goalName" placeholder="bijv. B1 Examen" style="font-family:'DM Sans',system-ui">
      </div>
      <div class="manual-field">
        <label>Type</label>
        <select id="goalType" onchange="onGoalTypeChange()">
          <option value="total">Totaal doel</option>
          <option value="recurring">Terugkerend doel</option>
          <option value="streak">Streak doel</option>
        </select>
      </div>

      <!-- Total goal fields -->
      <div id="goalTotalFields">
        <div class="manual-row">
          <div class="manual-field">
            <label>Doel waarde</label>
            <input type="number" id="goalTarget" placeholder="500" inputmode="decimal">
          </div>
          <div class="manual-field">
            <label>Eenheid</label>
            <select id="goalUnit">
              <option value="uur">Uren</option>
              <option value="kaarten">Kaarten</option>
              <option value="pagina">Pagina's</option>
              <option value="les">Lessen</option>
              <option value="stuk">Stuks</option>
            </select>
          </div>
        </div>
        <div class="manual-field">
          <label>Bron</label>
          <select id="goalSource">
            <option value="auto_hours">Automatisch (studie-uren)</option>
            <option value="auto_anki">Automatisch (Anki kaarten)</option>
            <option value="manual">Handmatig bijwerken</option>
          </select>
        </div>
        <div class="manual-field">
          <label>Vaardigheid filter (optioneel)</label>
          <select id="goalSkillFilter">
            <option value="">Alle vaardigheden</option>
            <option value="listening">Luisteren</option>
            <option value="reading">Lezen</option>
            <option value="writing">Schrijven</option>
            <option value="grammar">Grammatica</option>
          </select>
        </div>
      </div>

      <!-- Recurring goal fields -->
      <div id="goalRecurringFields" style="display:none">
        <div class="manual-row">
          <div class="manual-field">
            <label>Doel per periode</label>
            <input type="number" id="goalRecurringTarget" placeholder="30" inputmode="numeric">
          </div>
          <div class="manual-field">
            <label>Periode</label>
            <select id="goalRecurrence">
              <option value="daily">Per dag</option>
              <option value="weekly">Per week</option>
            </select>
          </div>
        </div>
        <div class="manual-row">
          <div class="manual-field">
            <label>Eenheid</label>
            <select id="goalRecurringUnit">
              <option value="min">Minuten</option>
              <option value="kaarten">Kaarten</option>
              <option value="pagina">Pagina's</option>
              <option value="stuk">Stuks</option>
            </select>
          </div>
          <div class="manual-field">
            <label>Bron</label>
            <select id="goalRecurringSource">
              <option value="auto_hours">Auto (studie-uren)</option>
              <option value="auto_anki">Auto (Anki)</option>
              <option value="manual">Handmatig</option>
            </select>
          </div>
        </div>
        <div class="manual-field">
          <label>Vaardigheid filter</label>
          <select id="goalRecurringSkillFilter">
            <option value="">Alle vaardigheden</option>
            <option value="listening">Luisteren</option>
            <option value="reading">Lezen</option>
            <option value="writing">Schrijven</option>
            <option value="grammar">Grammatica</option>
          </select>
        </div>
      </div>

      <!-- Streak goal fields -->
      <div id="goalStreakFields" style="display:none">
        <div class="manual-row">
          <div class="manual-field">
            <label>Streek doel (dagen)</label>
            <input type="number" id="goalStreakTarget" placeholder="30" inputmode="numeric">
          </div>
          <div class="manual-field">
            <label>Min. minuten/dag</label>
            <input type="number" id="goalStreakMinMinutes" placeholder="1" inputmode="numeric" value="1">
          </div>
        </div>
        <div class="manual-field">
          <label>Vaardigheid filter</label>
          <select id="goalStreakSkillFilter">
            <option value="">Alle vaardigheden</option>
            <option value="listening">Luisteren</option>
            <option value="reading">Lezen</option>
            <option value="writing">Schrijven</option>
            <option value="grammar">Grammatica</option>
          </select>
        </div>
        <div class="manual-field">
          <label style="display:flex;align-items:center;gap:8px">
            <span>Passief luisteren meetellen</span>
          </label>
          <button class="toggle on" id="goalStreakPassiveToggle" onclick="this.classList.toggle('on')"></button>
        </div>
      </div>

      <!-- Deadline -->
      <div class="manual-field">
        <label>Deadline (optioneel)</label>
        <input type="date" id="goalDeadline">
      </div>

      <!-- Milestones -->
      <div class="manual-field">
        <label style="display:flex;justify-content:space-between;align-items:center">
          <span>Mijlpalen</span>
          <button onclick="addMilestoneField()" style="background:var(--bg3);border:1px solid var(--bg4);border-radius:6px;padding:4px 10px;color:var(--text2);font-size:11px;cursor:pointer">+ Toevoegen</button>
        </label>
        <div id="milestonesContainer"></div>
      </div>

      <!-- Color/Icon -->
      <div class="manual-row">
        <div class="manual-field">
          <label>Kleur</label>
          <div class="tag-pills" id="goalColorPicker">
            <span class="tag-pill selected" data-color="--amber" onclick="pickGoalColor(this)" style="background:var(--amber-glow);border-color:var(--amber);color:var(--amber)">Amber</span>
            <span class="tag-pill" data-color="--teal" onclick="pickGoalColor(this)" style="color:var(--teal)">Teal</span>
            <span class="tag-pill" data-color="--blue" onclick="pickGoalColor(this)" style="color:var(--blue)">Blauw</span>
            <span class="tag-pill" data-color="--purple" onclick="pickGoalColor(this)" style="color:var(--purple)">Paars</span>
            <span class="tag-pill" data-color="--red" onclick="pickGoalColor(this)" style="color:var(--red)">Rood</span>
          </div>
        </div>
      </div>

      <div class="modal-btns" style="margin-top:8px">
        <button class="modal-btn cancel" onclick="closeGoalModal()">Annuleer</button>
        <button class="modal-btn confirm" onclick="saveGoal()">Opslaan</button>
      </div>
    </div>
  </div>
</div>

<!-- Goal Progress Update Modal -->
<div class="modal-overlay" id="goalProgressModal">
  <div class="modal">
    <h3 id="goalProgressTitle">Voortgang bijwerken</h3>
    <input type="hidden" id="goalProgressGoalId">
    <input type="hidden" id="goalProgressMetricId">
    <div class="manual-form">
      <div class="manual-row">
        <div class="manual-field">
          <label>Datum</label>
          <input type="date" id="goalProgressDate">
        </div>
        <div class="manual-field">
          <label id="goalProgressLabel">Waarde</label>
          <input type="number" id="goalProgressValue" placeholder="0" inputmode="numeric">
        </div>
      </div>
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="closeGoalProgressModal()">Annuleer</button>
        <button class="modal-btn confirm" onclick="saveGoalProgress()">Opslaan</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Undo Bar -->
<div class="undo-bar" id="undoBar">
  <span id="undoText"></span>
  <button class="undo-btn" onclick="undoLast()">Ongedaan</button>
</div>

<!-- Hidden file input for import -->
<input type="file" id="fileImport" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATABASE (IndexedDB)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB_NAME = 'DutchTrackerDB';
const DB_VERSION = 3;
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      const oldV = e.oldVersion;
      if (oldV < 1) {
        const s = d.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
        s.createIndex('date', 'date');
        s.createIndex('skill', 'skill');
        d.createObjectStore('settings', { keyPath: 'key' });
      }
      if (oldV < 2) {
        try {
          const logsStore = e.target.transaction.objectStore('logs');
          logsStore.createIndex('tags', 'tags', { multiEntry: true });
        } catch(err) {}
      }
      if (oldV < 3) {
        // Create goals store
        const goalsStore = d.createObjectStore('goals', { keyPath: 'id' });
        goalsStore.createIndex('status', 'status');
        // Create goal_progress store for manual metric tracking
        const progressStore = d.createObjectStore('goal_progress', { keyPath: 'id' });
        progressStore.createIndex('goalId', 'goalId');
        progressStore.createIndex('date', 'date');
        // Delete old vocab store if it exists
        if (d.objectStoreNames.contains('vocab')) {
          d.deleteObjectStore('vocab');
        }
        // Recreate anki store with better schema
        if (d.objectStoreNames.contains('anki')) {
          d.deleteObjectStore('anki');
        }
        const ankiStore = d.createObjectStore('anki', { keyPath: 'id', autoIncrement: true });
        ankiStore.createIndex('date', 'date');
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

function dbPut(store, data) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const s = tx.objectStore(store);
    const r = s.put(data);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}

function dbDelete(store, id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const r = tx.objectStore(store).delete(id);
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}

function dbGetAll(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const r = tx.objectStore(store).getAll();
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}

function dbGet(store, key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const r = tx.objectStore(store).get(key);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}

function dbClear(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const r = tx.objectStore(store).clear();
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let extendDayPastMidnight = false;
const today = () => {
  const now = new Date();
  if (extendDayPastMidnight && now.getHours() < 3) {
    const d = new Date(now);
    d.setDate(d.getDate() - 1);
    return d.toISOString().split('T')[0];
  }
  return now.toISOString().split('T')[0];
};
const genId = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
const SKILL_COLORS = {
  listening: { color: 'var(--teal)', bg: 'var(--teal-dim)', label: 'Luisteren', icon: 'üéß' },
  reading:   { color: 'var(--blue)', bg: 'var(--blue-dim)', label: 'Lezen', icon: 'üìñ' },
  writing:   { color: 'var(--purple)', bg: 'var(--purple-dim)', label: 'Schrijven', icon: '‚úçÔ∏è' },
  grammar:   { color: 'var(--amber)', bg: 'var(--amber-glow)', label: 'Grammatica', icon: 'üìê' }
};
const GOAL_COLORS = {
  '--amber': { color: 'var(--amber)', fill: 'var(--amber-glow)' },
  '--teal': { color: 'var(--teal)', fill: 'var(--teal-dim)' },
  '--blue': { color: 'var(--blue)', fill: 'var(--blue-dim)' },
  '--purple': { color: 'var(--purple)', fill: 'var(--purple-dim)' },
  '--red': { color: 'var(--red)', fill: 'var(--red-dim)' }
};
const EXAM_DATE = new Date('2026-05-10T00:00:00');
let hourGoal = 2;
let lastAction = null;
let currentPeriod = 'week';
let statsTagFilter = null;
let isPassive = false;
let isTimerPassive = false;

function daysUntilExam() {
  const now = new Date();
  now.setHours(0,0,0,0);
  return Math.max(0, Math.ceil((EXAM_DATE - now) / 86400000));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

function showUndo(text, action) {
  lastAction = action;
  const bar = document.getElementById('undoBar');
  document.getElementById('undoText').textContent = text;
  bar.classList.add('show');
  clearTimeout(bar._timer);
  bar._timer = setTimeout(() => { bar.classList.remove('show'); lastAction = null; }, 5000);
}

async function undoLast() {
  if (!lastAction) return;
  await lastAction();
  lastAction = null;
  document.getElementById('undoBar').classList.remove('show');
  showToast('Ongedaan gemaakt!');
  refreshAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view' + name).classList.add('active');
  btn.classList.add('active');
  document.getElementById('content').scrollTop = 0;
  if (name === 'Dashboard') refreshDashboard();
  if (name === 'Stats') refreshStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function quickLog(skill, minutes, passive) {
  const entry = { date: today(), skill, minutes, tags: [], notes: '', passive: !!passive, timestamp: Date.now() };
  const id = await dbPut('logs', entry);
  const s = SKILL_COLORS[skill];
  showToast(`${s.icon} +${minutes} min ${s.label}${passive ? ' (passief)' : ''}`);
  showUndo(`${s.icon} +${minutes}min`, () => dbDelete('logs', id));
  refreshAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIMER (STOPWATCH)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;

function timerUpdateDisplay() {
  const h = Math.floor(timerSeconds / 3600);
  const m = Math.floor((timerSeconds % 3600) / 60);
  const s = timerSeconds % 60;
  document.getElementById('timerDisplay').textContent =
    String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

function timerStart() {
  if (timerRunning) return;
  timerRunning = true;
  document.getElementById('timerDisplay').classList.add('running');
  document.getElementById('timerDisplay').classList.remove('paused');
  document.getElementById('timerStartBtn').style.display = 'none';
  document.getElementById('timerPauseBtn').style.display = '';
  document.getElementById('timerStopBtn').style.display = '';
  document.getElementById('timerSaveSection').style.display = 'none';
  timerInterval = setInterval(() => { timerSeconds++; timerUpdateDisplay(); }, 1000);
}

function timerPause() {
  if (!timerRunning) return;
  timerRunning = false;
  clearInterval(timerInterval);
  document.getElementById('timerDisplay').classList.remove('running');
  document.getElementById('timerDisplay').classList.add('paused');
  document.getElementById('timerPauseBtn').style.display = 'none';
  document.getElementById('timerStartBtn').style.display = '';
}

function timerStop() {
  timerRunning = false;
  clearInterval(timerInterval);
  document.getElementById('timerDisplay').classList.remove('running', 'paused');
  document.getElementById('timerStartBtn').style.display = 'none';
  document.getElementById('timerPauseBtn').style.display = 'none';
  document.getElementById('timerStopBtn').style.display = 'none';
  if (timerSeconds > 0) {
    const mins = Math.round(timerSeconds / 60);
    document.getElementById('timerResultTime').textContent = mins > 0 ? mins + ' min' : '< 1 min';
    document.getElementById('timerSaveSection').style.display = '';
  } else {
    timerReset();
  }
}

function timerSave() {
  const mins = Math.max(1, Math.round(timerSeconds / 60));
  const skill = document.getElementById('timerSkill').value;
  const passive = skill === 'listening' && isTimerPassive;
  quickLog(skill, mins, passive);
  isTimerPassive = false;
  const tp = document.getElementById('timerPassiveToggle');
  if (tp) tp.classList.remove('on');
  timerReset();
}

function timerDiscard() { timerReset(); }

function timerReset() {
  timerSeconds = 0;
  timerRunning = false;
  clearInterval(timerInterval);
  timerUpdateDisplay();
  document.getElementById('timerDisplay').classList.remove('running', 'paused');
  document.getElementById('timerStartBtn').style.display = '';
  document.getElementById('timerPauseBtn').style.display = 'none';
  document.getElementById('timerStopBtn').style.display = 'none';
  document.getElementById('timerSaveSection').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIDEO LENGTH CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calcValues = [];

function calcAdd() {
  const input = document.getElementById('calcInput');
  const val = parseFloat(input.value);
  if (isNaN(val) || val <= 0) { showToast('Vul een getal in!'); return; }
  calcValues.push(val);
  input.value = '';
  input.focus();
  calcRender();
}

function calcSubtract() {
  const input = document.getElementById('calcInput');
  const val = parseFloat(input.value);
  if (isNaN(val) || val <= 0) { showToast('Vul een getal in!'); return; }
  calcValues.push(-val);
  input.value = '';
  input.focus();
  calcRender();
}

function calcRemoveEntry(index) {
  calcValues.splice(index, 1);
  calcRender();
}

function calcClear() {
  calcValues = [];
  calcRender();
}

function calcRender() {
  const total = calcValues.reduce((s, v) => s + v, 0);
  document.getElementById('calcTotal').textContent = total.toFixed(2);
  document.getElementById('calcEntries').innerHTML = calcValues.map((v, i) =>
    '<span class="calc-entry" style="color:' + (v < 0 ? 'var(--red)' : 'var(--text)') + '">' + (v > 0 ? '+' : '') + v.toFixed(2) +
    '<button class="calc-entry-remove" onclick="calcRemoveEntry(' + i + ')">&times;</button></span>'
  ).join('');
}

function calcTransfer() {
  const total = calcValues.reduce((s, v) => s + v, 0);
  if (total <= 0) { showToast('Nog geen waarden!'); return; }
  const rounded = Math.round(total);
  document.getElementById('manualMinutes').value = rounded;
  showToast(rounded + ' min overgenomen');
  document.getElementById('manualMinutes').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ‚îÄ‚îÄ Tags & Manual Entry ‚îÄ‚îÄ
function toggleTag(el) {
  el.classList.toggle('selected');
}

function getSelectedTags() {
  return [...document.querySelectorAll('#manualTags .tag-pill.selected')]
    .map(el => el.dataset.tag);
}

async function saveManualEntry() {
  const date = document.getElementById('manualDate').value;
  const skill = document.getElementById('manualSkill').value;
  const minutes = parseInt(document.getElementById('manualMinutes').value) || 0;
  const notes = document.getElementById('manualNotes').value.trim();
  const tags = getSelectedTags();

  if (!date) { showToast('Kies een datum!'); return; }
  if (minutes === 0) { showToast('Vul minuten in!'); return; }

  const passive = skill === 'listening' && isPassive;
  const entry = { date, skill, minutes, tags, notes, passive, timestamp: Date.now() };
  const id = await dbPut('logs', entry);

  const s = SKILL_COLORS[skill];
  showToast(`${s.icon} Sessie opgeslagen`);
  showUndo('Handmatige invoer', () => dbDelete('logs', id));

  // Reset form
  document.getElementById('manualMinutes').value = '';
  document.getElementById('manualNotes').value = '';
  document.querySelectorAll('#manualTags .tag-pill').forEach(p => p.classList.remove('selected'));
  isPassive = false;
  const pt = document.getElementById('passiveToggle');
  if (pt) pt.classList.remove('on');
  refreshAll();
}

// ‚îÄ‚îÄ Passive Listening Toggle ‚îÄ‚îÄ
function togglePassive() {
  isPassive = !isPassive;
  document.getElementById('passiveToggle').classList.toggle('on', isPassive);
}
function toggleTimerPassive() {
  isTimerPassive = !isTimerPassive;
  document.getElementById('timerPassiveToggle').classList.toggle('on', isTimerPassive);
}
function onSkillChange() {
  const skill = document.getElementById('manualSkill').value;
  document.getElementById('passiveToggleWrap').style.display = skill === 'listening' ? '' : 'none';
  if (skill !== 'listening') { isPassive = false; document.getElementById('passiveToggle').classList.remove('on'); }
}
function onTimerSkillChange() {
  const skill = document.getElementById('timerSkill').value;
  document.getElementById('timerPassiveWrap').style.display = skill === 'listening' ? '' : 'none';
  if (skill !== 'listening') { isTimerPassive = false; document.getElementById('timerPassiveToggle').classList.remove('on'); }
}
function onEditSkillChange() {
  const skill = document.getElementById('editSkill').value;
  document.getElementById('editPassiveWrap').style.display = skill === 'listening' ? '' : 'none';
}

// ‚îÄ‚îÄ Anki Log ‚îÄ‚îÄ
async function saveAnkiEntry() {
  const date = document.getElementById('ankiDate').value;
  const cards = parseInt(document.getElementById('ankiCards').value) || 0;
  if (!date) { showToast('Kies een datum!'); return; }
  if (cards === 0) { showToast('Vul kaarten in!'); return; }
  const entry = { date, cards, timestamp: Date.now() };
  const id = await dbPut('anki', entry);
  showToast('Anki kaarten opgeslagen!');
  showUndo('Anki invoer', () => dbDelete('anki', id));
  document.getElementById('ankiCards').value = '';
  refreshAll();
}

// ‚îÄ‚îÄ Edit Entry ‚îÄ‚îÄ
let editingEntryId = null;
let editPassiveState = false;

async function editEntry(id) {
  const entry = await dbGet('logs', id);
  if (!entry) { showToast('Item niet gevonden'); return; }
  editingEntryId = id;
  document.getElementById('editEntryId').value = id;
  document.getElementById('editDate').value = entry.date;
  document.getElementById('editSkill').value = entry.skill;
  document.getElementById('editMinutes').value = entry.minutes;
  document.getElementById('editNotes').value = entry.notes || '';
  editPassiveState = !!entry.passive;
  document.getElementById('editPassiveToggle').classList.toggle('on', editPassiveState);
  document.getElementById('editPassiveWrap').style.display = entry.skill === 'listening' ? '' : 'none';
  // Set tags
  document.querySelectorAll('#editTags .tag-pill').forEach(p => {
    p.classList.toggle('selected', (entry.tags || []).includes(p.dataset.tag));
  });
  document.getElementById('editModal').classList.add('show');
}

function toggleEditPassive() {
  editPassiveState = !editPassiveState;
  document.getElementById('editPassiveToggle').classList.toggle('on', editPassiveState);
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('show');
  editingEntryId = null;
}

async function saveEdit() {
  const id = editingEntryId;
  if (!id) return;
  const oldEntry = await dbGet('logs', id);
  const date = document.getElementById('editDate').value;
  const skill = document.getElementById('editSkill').value;
  const minutes = parseInt(document.getElementById('editMinutes').value) || 0;
  const notes = document.getElementById('editNotes').value.trim();
  const tags = [...document.querySelectorAll('#editTags .tag-pill.selected')].map(el => el.dataset.tag);
  const passive = skill === 'listening' && editPassiveState;
  if (!date || minutes === 0) { showToast('Vul datum en minuten in!'); return; }
  const updated = { ...oldEntry, date, skill, minutes, notes, tags, passive, timestamp: Date.now() };
  await dbPut('logs', updated);
  showToast('Bijgewerkt!');
  showUndo('Bewerking ongedaan', () => dbPut('logs', oldEntry));
  closeEditModal();
  refreshAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Compute the effective daily goal in hours from pinned total goals with a deadline.
// Falls back to the manual hourGoal setting if no relevant big goals exist.
async function computeEffectiveDailyGoal(logs) {
  let goals = [];
  try { goals = await dbGetAll('goals'); } catch(e) {}
  const relevantGoals = goals.filter(g =>
    g.status === 'active' &&
    g.pinToDashboard &&
    g.type === 'total' &&
    g.deadline &&
    g.metrics && g.metrics.some(m => m.source === 'auto_hours' && m.unit === 'uur')
  );
  if (relevantGoals.length === 0) return hourGoal;

  let ankiEntries = [];
  let progressEntries = [];
  try { ankiEntries = await dbGetAll('anki'); } catch(e) {}
  try { progressEntries = await dbGetAll('goal_progress'); } catch(e) {}

  let totalPace = 0;
  for (const goal of relevantGoals) {
    const progress = await computeGoalProgress(goal, logs, ankiEntries, progressEntries);
    for (const p of progress) {
      if (p.unit === 'uur') {
        const pace = computeDailyPace(goal, p);
        if (pace && pace.needed > 0) totalPace += parseFloat(pace.needed);
      }
    }
  }
  return totalPace > 0 ? totalPace : hourGoal;
}

async function refreshDashboard() {
  const d = today();

  // Logs
  const logs = await dbGetAll('logs');
  const todayLogs = logs.filter(l => l.date === d);
  const totalMin = todayLogs.reduce((s, l) => s + l.minutes, 0);
  document.getElementById('todayHours').textContent = (totalMin / 60).toFixed(1);

  // Total study hours (all time)
  const allTotalMin = logs.reduce((s, l) => s + l.minutes, 0);
  const totalHours = allTotalMin / 60;
  document.getElementById('totalStudyHours').textContent = totalHours.toFixed(2);

  // Anki today
  try {
    const ankiEntries = await dbGetAll('anki');
    const todayAnki = ankiEntries.filter(a => a.date === d).reduce((s, a) => s + (a.cards || 0), 0);
    document.getElementById('todayAnki').textContent = todayAnki;
  } catch(e) { document.getElementById('todayAnki').textContent = '0'; }

  // Goals
  await renderGoals(logs);

  // Effective daily goal (from big goals, or fallback to manual setting)
  const effectiveDailyGoal = await computeEffectiveDailyGoal(logs);

  // Streak
  const streak = calcStreak(logs);
  document.getElementById('streakCount').textContent = streak;

  // Week heatmap
  renderWeekGrid(logs, effectiveDailyGoal);

  // Goal progress
  const goalPct = Math.min(100, (totalMin / (effectiveDailyGoal * 60)) * 100);
  const goalHours = (totalMin / 60).toFixed(1);
  document.getElementById('goalCurrent').textContent = goalHours;
  document.getElementById('dailyGoalDisplay').textContent = `/ ${effectiveDailyGoal.toFixed(1)}u`;
  document.getElementById('goalPct').textContent = Math.round(goalPct) + '%';
  const circumference = 213.6;
  document.getElementById('goalRing').style.strokeDashoffset = circumference * (1 - goalPct / 100);
  let goalColor, goalMsg;
  if (goalPct === 0) { goalColor = 'var(--text3)'; goalMsg = 'Begin met studeren!'; }
  else if (goalPct < 25) { goalColor = 'var(--red)'; goalMsg = 'Goed begin!'; }
  else if (goalPct < 50) { goalColor = 'var(--amber)'; goalMsg = 'Je bent op weg!'; }
  else if (goalPct < 75) { goalColor = 'var(--amber)'; goalMsg = 'Meer dan halverwege!'; }
  else if (goalPct < 100) { goalColor = 'var(--blue)'; goalMsg = 'Bijna daar!'; }
  else { goalColor = 'var(--teal)'; goalMsg = 'Doel bereikt!'; }
  document.getElementById('goalRing').style.stroke = goalColor;
  document.getElementById('goalPct').style.color = goalColor;
  document.getElementById('goalMsg').textContent = goalMsg;
  const goalLeftEl = document.getElementById('goalLeft');
  if (goalLeftEl) {
    if (goalPct >= 100) {
      goalLeftEl.textContent = '';
    } else {
      const hoursLeft = Math.max(0, effectiveDailyGoal - totalMin / 60);
      goalLeftEl.textContent = `${hoursLeft.toFixed(1)}u nog te gaan`;
    }
  }

  // Total skills
  renderSkillBars('skillBarsTotal', logs, null, true);
}

function calcStreak(logs) {
  const dates = [...new Set(logs.map(l => l.date))].sort().reverse();
  if (dates.length === 0) return 0;
  const d = today();
  let streak = 0;
  let checkDate = new Date(d);

  // If no study today, start checking from yesterday
  if (!dates.includes(d)) {
    checkDate.setDate(checkDate.getDate() - 1);
  }

  for (let i = 0; i < 1000; i++) {
    const ds = checkDate.toISOString().split('T')[0];
    if (dates.includes(ds)) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

function renderSkillBars(containerId, logs, maxMin, showTotal) {
  const container = document.getElementById(containerId);
  const skills = ['listening', 'reading', 'writing', 'grammar'];
  let totalAll = 0;
  const mins = {};
  skills.forEach(s => {
    mins[s] = logs.filter(l => l.skill === s).reduce((sum, l) => sum + l.minutes, 0);
    totalAll += mins[s];
  });

  // Listening sub-breakdown
  const listenActive = logs.filter(l => l.skill === 'listening' && !l.passive).reduce((s, l) => s + l.minutes, 0);
  const listenPassive = logs.filter(l => l.skill === 'listening' && l.passive).reduce((s, l) => s + l.minutes, 0);

  const maxVal = maxMin || Math.max(totalAll, 1);
  let html = '';

  skills.forEach(s => {
    const m = mins[s];
    const sc = SKILL_COLORS[s];
    const pct = maxMin ? Math.min(100, (m / maxMin) * 100 * 4) : (totalAll ? (m / totalAll) * 100 : 0);
    const timeStr = showTotal ? (m >= 60 ? `${(m/60).toFixed(1)}u` : `${m}min`) : `${m}min`;
    html += `
      <div class="skill-bar-wrap">
        <div class="skill-bar-header">
          <div class="skill-bar-name"><span class="dot" style="background:${sc.color}"></span>${sc.label}</div>
          <div class="skill-bar-time">${timeStr}</div>
        </div>
        <div class="skill-bar-track">
          <div class="skill-bar-fill" style="width:${Math.max(pct, m > 0 ? 3 : 0)}%;background:${sc.color}"></div>
        </div>
      </div>`;

    // Show active/passive breakdown for listening
    if (s === 'listening' && (listenActive > 0 || listenPassive > 0)) {
      const aTime = showTotal ? (listenActive >= 60 ? `${(listenActive/60).toFixed(1)}u` : `${listenActive}min`) : `${listenActive}min`;
      const pTime = showTotal ? (listenPassive >= 60 ? `${(listenPassive/60).toFixed(1)}u` : `${listenPassive}min`) : `${listenPassive}min`;
      if (listenActive > 0) {
        const aPct = maxMin ? Math.min(100, (listenActive / maxMin) * 100 * 4) : (totalAll ? (listenActive / totalAll) * 100 : 0);
        html += `<div class="skill-bar-wrap" style="margin-left:20px;margin-top:-4px">
          <div class="skill-bar-header">
            <div class="skill-bar-name" style="font-size:11px;color:var(--text3)">Actief</div>
            <div class="skill-bar-time" style="font-size:10px">${aTime}</div>
          </div>
          <div class="skill-bar-track" style="height:4px">
            <div class="skill-bar-fill" style="width:${Math.max(aPct, listenActive > 0 ? 3 : 0)}%;background:var(--teal)"></div>
          </div>
        </div>`;
      }
      if (listenPassive > 0) {
        const pPct = maxMin ? Math.min(100, (listenPassive / maxMin) * 100 * 4) : (totalAll ? (listenPassive / totalAll) * 100 : 0);
        html += `<div class="skill-bar-wrap" style="margin-left:20px;margin-top:-4px">
          <div class="skill-bar-header">
            <div class="skill-bar-name" style="font-size:11px;color:var(--text3)">Passief</div>
            <div class="skill-bar-time" style="font-size:10px">${pTime}</div>
          </div>
          <div class="skill-bar-track" style="height:4px">
            <div class="skill-bar-fill" style="width:${Math.max(pPct, listenPassive > 0 ? 3 : 0)}%;background:rgba(45,212,168,0.5)"></div>
          </div>
        </div>`;
      }
    }
  });

  // Add total hours
  if (showTotal && totalAll > 0) {
    html += `<div class="skill-total">Totaal: ${(totalAll/60).toFixed(1)}u</div>`;
  }
  container.innerHTML = html;
}

function renderWeekGrid(logs, effectiveDailyGoal) {
  const goal = effectiveDailyGoal || hourGoal;
  const grid = document.getElementById('weekGrid');
  const d = today();
  const todayDate = new Date(d);
  const dayOfWeek = todayDate.getDay();
  const monday = new Date(todayDate);
  monday.setDate(todayDate.getDate() - ((dayOfWeek + 6) % 7));

  const dayNames = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];
  let html = '';
  let weekTotalMins = 0;

  for (let i = 0; i < 7; i++) {
    const date = new Date(monday);
    date.setDate(monday.getDate() + i);
    const ds = date.toISOString().split('T')[0];
    const dayMins = logs.filter(l => l.date === ds).reduce((s, l) => s + l.minutes, 0);
    const hours = (dayMins / 60).toFixed(1);
    const isToday = ds === d;
    const isFuture = date > todayDate;

    let cls = 'empty';
    if (!isFuture && dayMins > 0) {
      if (dayMins >= goal * 60) cls = 'good';
      else if (dayMins >= goal * 30) cls = 'mid';
      else cls = 'low';
    }

    html += `
      <div class="week-cell ${cls} ${isToday ? 'today' : ''}">
        <span class="day-name">${dayNames[i]}</span>
        <span class="day-hours">${isFuture ? '‚Äì' : hours}</span>
      </div>`;
    if (!isFuture) weekTotalMins += dayMins;
  }
  html += `<div class="week-total">Totaal: ${(weekTotalMins / 60).toFixed(1)}u</div>`;
  grid.innerHTML = html;

  // Weekly goal summary
  const weeklyTarget = goal * 7;
  const weekHours = weekTotalMins / 60;
  const weekPct = Math.min(100, (weekHours / weeklyTarget) * 100);
  const summaryEl = document.getElementById('weekGoalSummary');
  if (summaryEl) {
    const summaryColor = weekPct >= 100 ? 'var(--teal)' : weekPct >= 50 ? 'var(--amber)' : 'var(--text3)';
    const weekLeft = Math.max(0, weeklyTarget - weekHours);
    summaryEl.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:12px">
        <span style="color:var(--text3);font-weight:600">Weekdoel</span>
        <span style="color:${summaryColor};font-family:'JetBrains Mono',monospace;font-weight:700">${weekHours.toFixed(1)} / ${weeklyTarget.toFixed(1)}u</span>
      </div>
      <div class="goal-progress-track" style="margin-bottom:${weekPct < 100 ? '4px' : '8px'}">
        <div class="goal-progress-fill" style="width:${weekPct}%;background:${summaryColor}"></div>
      </div>
      ${weekPct < 100 ? `<div style="text-align:right;margin-bottom:8px;font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace">${weekLeft.toFixed(1)}u nog te gaan</div>` : ''}`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS / CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPeriod(p, btn) {
  currentPeriod = p;
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  refreshStats();
}

async function refreshStats() {
  const allLogs = await dbGetAll('logs');

  // Build tag filter pills
  const allTags = [...new Set(allLogs.flatMap(l => l.tags || []))].sort();
  const filterContainer = document.getElementById('statsTagFilter');
  let filterHtml = '<span class="tag-pill' + (!statsTagFilter ? ' selected' : '') + '" onclick="setStatsTagFilter(null, this)">Alles</span>';
  allTags.forEach(tag => {
    filterHtml += '<span class="tag-pill' + (statsTagFilter === tag ? ' selected' : '') + '" data-tag="' + tag + '" onclick="setStatsTagFilter(\'' + tag + '\', this)">' + tag.charAt(0).toUpperCase() + tag.slice(1) + '</span>';
  });
  filterContainer.innerHTML = filterHtml;

  // Apply tag filter
  const logs = statsTagFilter
    ? allLogs.filter(l => (l.tags || []).includes(statsTagFilter))
    : allLogs;

  const now = new Date();
  let startDate;
  if (currentPeriod === 'week') {
    startDate = new Date(now); startDate.setDate(now.getDate() - 6);
  } else if (currentPeriod === 'month') {
    startDate = new Date(now); startDate.setDate(now.getDate() - 29);
  } else {
    const allDates = logs.map(l => l.date);
    startDate = allDates.length ? new Date(allDates.sort()[0]) : new Date(now);
  }
  startDate.setHours(0,0,0,0);

  const dates = [];
  const d = new Date(startDate);
  const endDate = new Date(now);
  endDate.setHours(0,0,0,0);
  while (d <= endDate) {
    dates.push(d.toISOString().split('T')[0]);
    d.setDate(d.getDate() + 1);
  }

  // Hours per day
  const hoursData = dates.map(dt => {
    const mins = logs.filter(l => l.date === dt).reduce((s, l) => s + l.minutes, 0);
    return mins / 60;
  });

  // Skill distribution
  const skillTotals = {};
  ['listening', 'reading', 'writing', 'grammar'].forEach(s => {
    const filtered = logs.filter(l => l.date >= dates[0] && l.date <= dates[dates.length - 1] && l.skill === s);
    skillTotals[s] = filtered.reduce((sum, l) => sum + l.minutes, 0);
  });

  // Tag distribution
  const tagTotals = {};
  const periodLogs = logs.filter(l => dates.length > 0 && l.date >= dates[0] && l.date <= dates[dates.length - 1]);
  periodLogs.forEach(l => {
    (l.tags || []).forEach(tag => { tagTotals[tag] = (tagTotals[tag] || 0) + l.minutes; });
  });

  drawBarChart('hoursChart', dates, hoursData, 'var(--amber)', hourGoal);
  drawDonutChart('skillChart', skillTotals);
  drawTagChart(tagTotals);
  renderHistory(dates, logs);
}

function setStatsTagFilter(tag, el) {
  statsTagFilter = tag;
  document.querySelectorAll('#statsTagFilter .tag-pill').forEach(p => p.classList.remove('selected'));
  el.classList.add('selected');
  refreshStats();
}

function drawTagChart(tagTotals) {
  const canvas = document.getElementById('tagChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.scale(dpr, dpr);

  const w = rect.width;
  const h = rect.height;
  ctx.clearRect(0, 0, w, h);

  const tags = Object.keys(tagTotals).sort((a, b) => tagTotals[b] - tagTotals[a]);
  if (tags.length === 0) {
    const style = getComputedStyle(document.documentElement);
    ctx.fillStyle = style.getPropertyValue('--text3').trim();
    ctx.font = '13px DM Sans, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Geen tags', w / 2, h / 2);
    return;
  }

  const style = getComputedStyle(document.documentElement);
  const pad = { top: 10, right: 10, bottom: 28, left: 80 };
  const chartW = w - pad.left - pad.right;
  const chartH = h - pad.top - pad.bottom;
  const barH = Math.min(chartH / tags.length * 0.7, 24);
  const gap = chartH / tags.length;
  const maxVal = Math.max(...Object.values(tagTotals), 1);
  const barColor = style.getPropertyValue('--purple').trim();
  const textColor = style.getPropertyValue('--text2').trim();

  tags.forEach((tag, i) => {
    const mins = tagTotals[tag];
    const barW = (mins / maxVal) * chartW;
    const y = pad.top + i * gap + (gap - barH) / 2;
    ctx.fillStyle = barColor;
    ctx.globalAlpha = 0.8;
    ctx.beginPath();
    const r = 3;
    ctx.moveTo(pad.left, y);
    ctx.lineTo(pad.left + barW - r, y);
    ctx.quadraticCurveTo(pad.left + barW, y, pad.left + barW, y + r);
    ctx.lineTo(pad.left + barW, y + barH - r);
    ctx.quadraticCurveTo(pad.left + barW, y + barH, pad.left + barW - r, y + barH);
    ctx.lineTo(pad.left, y + barH);
    ctx.closePath();
    ctx.fill();
    ctx.globalAlpha = 1;

    // Tag label
    ctx.fillStyle = textColor;
    ctx.font = '11px DM Sans, system-ui';
    ctx.textAlign = 'right';
    ctx.fillText(tag.charAt(0).toUpperCase() + tag.slice(1), pad.left - 6, y + barH / 2 + 4);

    // Value
    ctx.fillStyle = textColor;
    ctx.font = '10px JetBrains Mono, monospace';
    ctx.textAlign = 'left';
    const timeStr = mins >= 60 ? (mins / 60).toFixed(1) + 'u' : mins + 'min';
    ctx.fillText(timeStr, pad.left + barW + 6, y + barH / 2 + 4);
  });
}

function drawBarChart(canvasId, labels, data, color, goalLine) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.scale(dpr, dpr);

  const w = rect.width;
  const h = rect.height;
  const pad = { top: 10, right: 10, bottom: 28, left: 36 };
  const chartW = w - pad.left - pad.right;
  const chartH = h - pad.top - pad.bottom;

  ctx.clearRect(0, 0, w, h);

  const maxVal = Math.max(...data, goalLine || 0, 1) * 1.2;
  const barW = Math.min(chartW / labels.length * 0.7, 20);
  const gap = chartW / labels.length;

  // Get computed styles
  const style = getComputedStyle(document.documentElement);
  const textColor = style.getPropertyValue('--text3').trim() || '#5a5a6a';
  const gridColor = style.getPropertyValue('--bg3').trim() || '#1e1e28';
  const barColor = style.getPropertyValue(color.replace('var(', '').replace(')', '')).trim() || color;

  // Grid lines
  ctx.strokeStyle = gridColor;
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + chartH - (chartH * i / 4);
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(w - pad.right, y);
    ctx.stroke();
    ctx.fillStyle = textColor;
    ctx.font = '10px JetBrains Mono, monospace';
    ctx.textAlign = 'right';
    ctx.fillText((maxVal * i / 4).toFixed(1), pad.left - 4, y + 3);
  }

  // Goal line
  if (goalLine) {
    const goalY = pad.top + chartH - (chartH * goalLine / maxVal);
    ctx.strokeStyle = 'rgba(240,64,96,0.5)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(pad.left, goalY);
    ctx.lineTo(w - pad.right, goalY);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(240,64,96,0.7)';
    ctx.font = '9px JetBrains Mono, monospace';
    ctx.textAlign = 'left';
    ctx.fillText('doel', w - pad.right - 24, goalY - 4);
  }

  // Bars
  data.forEach((val, i) => {
    const x = pad.left + i * gap + (gap - barW) / 2;
    const barH = (val / maxVal) * chartH;
    const y = pad.top + chartH - barH;

    const isToday = labels[i] === today();
    ctx.fillStyle = barColor;
    ctx.globalAlpha = isToday ? 1 : 0.7;
    ctx.beginPath();
    const r = Math.min(3, barW / 2);
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + barW - r, y);
    ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
    ctx.lineTo(x + barW, pad.top + chartH);
    ctx.lineTo(x, pad.top + chartH);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Date labels (show every Nth)
    const showEvery = labels.length > 14 ? Math.ceil(labels.length / 7) : (labels.length > 7 ? 2 : 1);
    if (i % showEvery === 0 || isToday) {
      ctx.fillStyle = isToday ? barColor : textColor;
      ctx.font = `${isToday ? 'bold ' : ''}9px DM Sans, system-ui`;
      ctx.textAlign = 'center';
      const dateLabel = labels[i].slice(5).replace('-', '/');
      ctx.fillText(dateLabel, x + barW / 2, h - pad.bottom + 14);
    }
  });
}

function drawDonutChart(canvasId, skillTotals) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.scale(dpr, dpr);

  const w = rect.width;
  const h = rect.height;
  ctx.clearRect(0, 0, w, h);

  const total = Object.values(skillTotals).reduce((s, v) => s + v, 0);
  if (total === 0) {
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text3').trim();
    ctx.font = '13px DM Sans, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Nog geen data', w / 2, h / 2);
    return;
  }

  const style = getComputedStyle(document.documentElement);
  const colors = {
    listening: style.getPropertyValue('--teal').trim(),
    reading: style.getPropertyValue('--blue').trim(),
    writing: style.getPropertyValue('--purple').trim(),
    grammar: style.getPropertyValue('--amber').trim()
  };

  const cx = w * 0.35;
  const cy = h / 2;
  const outerR = Math.min(cx - 10, cy - 10);
  const innerR = outerR * 0.55;

  let angle = -Math.PI / 2;
  Object.entries(skillTotals).forEach(([skill, mins]) => {
    if (mins === 0) return;
    const slice = (mins / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.arc(cx, cy, outerR, angle, angle + slice);
    ctx.arc(cx, cy, innerR, angle + slice, angle, true);
    ctx.closePath();
    ctx.fillStyle = colors[skill];
    ctx.fill();
    angle += slice;
  });

  // Center text
  ctx.fillStyle = style.getPropertyValue('--text').trim();
  ctx.font = 'bold 18px JetBrains Mono, monospace';
  ctx.textAlign = 'center';
  ctx.fillText(`${(total / 60).toFixed(1)}u`, cx, cy + 2);
  ctx.fillStyle = style.getPropertyValue('--text3').trim();
  ctx.font = '10px DM Sans, system-ui';
  ctx.fillText('totaal', cx, cy + 16);

  // Legend
  const legendX = w * 0.65;
  let ly = 20;
  Object.entries(SKILL_COLORS).forEach(([skill, info]) => {
    const mins = skillTotals[skill] || 0;
    const pct = total ? Math.round(mins / total * 100) : 0;
    ctx.fillStyle = colors[skill];
    ctx.beginPath();
    ctx.arc(legendX, ly + 6, 5, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = style.getPropertyValue('--text').trim();
    ctx.font = '12px DM Sans, system-ui';
    ctx.textAlign = 'left';
    ctx.fillText(`${info.label}`, legendX + 14, ly + 10);
    ctx.fillStyle = style.getPropertyValue('--text2').trim();
    ctx.font = '11px JetBrains Mono, monospace';
    ctx.fillText(`${pct}%  ${mins >= 60 ? (mins/60).toFixed(1) + 'u' : mins + 'm'}`, legendX + 14, ly + 26);
    ly += 40;
  });
}

function renderHistory(dates, logs) {
  const container = document.getElementById('historyList');
  const reversed = [...dates].reverse().slice(0, 30);
  let html = '';
  for (const dt of reversed) {
    const dayLogs = logs.filter(l => l.date === dt);
    if (dayLogs.length === 0) continue;
    const dateObj = new Date(dt);
    const label = dt === today() ? 'Vandaag' :
      dateObj.toLocaleDateString('nl-BE', { weekday: 'short', day: 'numeric', month: 'short' });
    const dayMins = dayLogs.reduce((s, l) => s + l.minutes, 0);
    html += '<div class="history-day-header">' + label + ' ‚Äî ' + (dayMins/60).toFixed(1) + 'u</div>';
    for (const log of dayLogs) {
      const sc = SKILL_COLORS[log.skill];
      const passiveLabel = log.passive ? ' (passief)' : '';
      const meta = (log.tags && log.tags.length ? log.tags.join(', ') : '') +
        (log.notes ? (log.tags && log.tags.length ? ' ¬∑ ' : '') + log.notes : '');
      html += '<div class="history-entry">' +
        '<div class="history-entry-info">' +
          '<div class="history-entry-skill">' + sc.icon + ' ' + sc.label + passiveLabel + '</div>' +
          (meta ? '<div class="history-entry-meta">' + meta + '</div>' : '') +
        '</div>' +
        '<div class="history-entry-time">' + log.minutes + 'min</div>' +
        '<div style="display:flex;gap:2px">' +
          '<button class="history-delete-btn" onclick="editEntry(' + log.id + ')" title="Bewerken">‚úèÔ∏è</button>' +
          '<button class="history-delete-btn" onclick="deleteEntry(\'logs\',' + log.id + ')" title="Verwijderen">üóë</button>' +
        '</div>' +
      '</div>';
    }
  }
  container.innerHTML = html || '<div style="text-align:center;color:var(--text3);padding:20px;font-size:13px">Nog geen data</div>';
}

async function deleteEntry(store, id) {
  if (!confirm('Dit item verwijderen?')) return;
  const entry = await dbGet(store, id);
  await dbDelete(store, id);
  showToast('Verwijderd');
  showUndo('Item verwijderd', () => dbPut(store, entry));
  refreshAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getWeekStart() {
  const d = new Date(today());
  const dow = d.getDay();
  d.setDate(d.getDate() - ((dow + 6) % 7));
  return d.toISOString().split('T')[0];
}

async function computeGoalProgress(goal, logs, ankiEntries, progressEntries) {
  const results = [];
  for (const metric of goal.metrics) {
    let current = 0;
    if (metric.source === 'auto_hours') {
      let filtered = logs;
      if (metric.skillFilter) filtered = filtered.filter(l => l.skill === metric.skillFilter);
      if (metric.passiveFilter === 'active_only') filtered = filtered.filter(l => !l.passive);
      else if (metric.passiveFilter === 'passive_only') filtered = filtered.filter(l => l.passive === true);
      if (goal.type === 'recurring') {
        if (metric.recurrence === 'daily') filtered = filtered.filter(l => l.date === today());
        else if (metric.recurrence === 'weekly') {
          const ws = getWeekStart();
          filtered = filtered.filter(l => l.date >= ws);
        }
        current = filtered.reduce((s, l) => s + l.minutes, 0);
      } else {
        current = filtered.reduce((s, l) => s + l.minutes, 0) / 60;
      }
    } else if (metric.source === 'auto_anki') {
      if (goal.type === 'recurring' && metric.recurrence === 'daily') {
        current = ankiEntries.filter(a => a.date === today()).reduce((s, a) => s + (a.cards || 0), 0);
      } else if (goal.type === 'recurring' && metric.recurrence === 'weekly') {
        const ws = getWeekStart();
        current = ankiEntries.filter(a => a.date >= ws).reduce((s, a) => s + (a.cards || 0), 0);
      } else {
        current = ankiEntries.reduce((s, a) => s + (a.cards || 0), 0);
      }
    } else if (metric.source === 'manual') {
      const mine = progressEntries.filter(p => p.goalId === goal.id && p.metricId === metric.id);
      if (goal.type === 'recurring') {
        if (metric.recurrence === 'daily') {
          current = mine.filter(p => p.date === today()).reduce((s, p) => s + p.value, 0);
        } else if (metric.recurrence === 'weekly') {
          const ws = getWeekStart();
          current = mine.filter(p => p.date >= ws).reduce((s, p) => s + p.value, 0);
        }
      } else {
        current = mine.reduce((s, p) => s + p.value, 0);
      }
    }
    const target = goal.type === 'recurring' ? (metric.recurringTarget || metric.target) : metric.target;
    results.push({ metricId: metric.id, label: metric.label, unit: metric.unit, current, target, pct: target > 0 ? Math.min(100, (current / target) * 100) : 0 });
  }
  return results;
}

function computeGoalStreak(goal, logs) {
  const config = goal.streakConfig;
  if (!config) return 0;
  let filtered = logs;
  if (config.skillFilter) filtered = filtered.filter(l => l.skill === config.skillFilter);
  if (!config.includePassive) filtered = filtered.filter(l => !l.passive);
  const dateMinutes = {};
  filtered.forEach(l => { dateMinutes[l.date] = (dateMinutes[l.date] || 0) + l.minutes; });
  let streak = 0;
  let checkDate = new Date(today());
  if (!dateMinutes[today()] || dateMinutes[today()] < config.minimumMinutes) {
    checkDate.setDate(checkDate.getDate() - 1);
  }
  for (let i = 0; i < 1000; i++) {
    const ds = checkDate.toISOString().split('T')[0];
    if (dateMinutes[ds] && dateMinutes[ds] >= config.minimumMinutes) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else break;
  }
  return streak;
}

function computeDailyPace(goal, metricResult) {
  if (!goal.deadline) return null;
  const remaining = metricResult.target - metricResult.current;
  if (remaining <= 0) return { needed: 0, unit: metricResult.unit, daysLeft: 0 };
  const deadlineDate = new Date(goal.deadline);
  const now = new Date(); now.setHours(0,0,0,0);
  const daysLeft = Math.max(1, Math.ceil((deadlineDate - now) / 86400000));
  return { needed: (remaining / daysLeft).toFixed(1), unit: metricResult.unit, daysLeft };
}

async function renderGoals(logs) {
  const container = document.getElementById('goalsSection');
  let goals = [];
  try { goals = await dbGetAll('goals'); } catch(e) {}
  const activeGoals = goals.filter(g => g.status === 'active' && g.pinToDashboard).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
  if (activeGoals.length === 0) {
    container.innerHTML = '';
    return;
  }
  let ankiEntries = [];
  let progressEntries = [];
  try { ankiEntries = await dbGetAll('anki'); } catch(e) {}
  try { progressEntries = await dbGetAll('goal_progress'); } catch(e) {}

  let html = '';
  for (const goal of activeGoals) {
    const style = getComputedStyle(document.documentElement);
    const colorVar = goal.color || '--amber';
    const colorVal = style.getPropertyValue(colorVar).trim() || '#e8a020';

    html += `<div class="goal-card-new" style="border-color:${colorVal}20">`;
    html += `<div class="goal-card-header">
      <div class="goal-card-name" style="color:${colorVal}">${goal.icon || 'üéØ'} ${goal.name}</div>
      <div class="goal-card-actions">`;

    // Show + button for manual metrics
    const hasManual = goal.metrics && goal.metrics.some(m => m.source === 'manual');
    if (hasManual) {
      const manualMetric = goal.metrics.find(m => m.source === 'manual');
      html += `<button onclick="openGoalProgressModal('${goal.id}','${manualMetric.id}','${manualMetric.label}')" title="Voortgang bijwerken">+</button>`;
    }
    html += `<button onclick="openGoalModal('${goal.id}')" title="Bewerken">‚úèÔ∏è</button>`;
    html += `<button onclick="archiveGoal('${goal.id}')" title="Archiveren">üì¶</button>`;
    html += `</div></div>`;

    if (goal.type === 'streak') {
      const streak = computeGoalStreak(goal, logs);
      const target = goal.streakConfig ? (goal.metrics[0]?.target || 30) : 30;
      html += `<div class="goal-streak-display">
        <div class="goal-streak-number" style="color:${colorVal}">${streak}</div>
        <div class="goal-streak-label">dagen streak${target ? ` / ${target} doel` : ''}</div>
      </div>`;
      const pct = target > 0 ? Math.min(100, (streak / target) * 100) : 0;
      html += `<div class="goal-progress-track"><div class="goal-progress-fill" style="width:${pct}%;background:${colorVal}"></div></div>`;
    } else {
      const progress = await computeGoalProgress(goal, logs, ankiEntries, progressEntries);
      for (const p of progress) {
        const curStr = goal.type === 'recurring' && p.unit === 'min' ? `${Math.round(p.current)}` : (Number.isInteger(p.current) ? p.current : p.current.toFixed(1));
        const tarStr = goal.type === 'recurring' && p.unit === 'min' ? `${p.target}` : (Number.isInteger(p.target) ? p.target : p.target);
        html += `<div class="goal-metric">
          <div class="goal-metric-header">
            <span class="goal-metric-label">${p.label}</span>
            <span class="goal-metric-value" style="color:${colorVal}">${curStr} / ${tarStr} ${p.unit}</span>
          </div>
          <div class="goal-progress-track"><div class="goal-progress-fill" style="width:${p.pct}%;background:${colorVal}"></div></div>
        </div>`;

        // Daily pace
        if (goal.type === 'total' && goal.deadline) {
          const pace = computeDailyPace(goal, p);
          if (pace && pace.needed > 0) {
            html += `<div class="goal-pace">${pace.needed} ${p.unit}/dag nodig (${pace.daysLeft} dagen over)</div>`;
          } else if (pace && pace.needed <= 0) {
            html += `<div class="goal-pace" style="color:var(--teal)">Doel bereikt!</div>`;
          }
        }
      }

      // Milestones
      if (goal.milestones && goal.milestones.length > 0) {
        const mainProgress = progress[0];
        for (const ms of goal.milestones) {
          const reached = mainProgress && mainProgress.current >= ms.targetValue;
          html += `<div class="goal-milestone ${reached ? 'reached' : ''}">
            ${reached ? '‚úÖ' : '‚¨ú'} ${ms.label}${ms.deadline ? ' ‚Äî ' + ms.deadline : ''}
          </div>`;
        }
      }
    }
    html += `</div>`;
  }
  container.innerHTML = html;
}

// ‚îÄ‚îÄ Goal Modal ‚îÄ‚îÄ
async function openGoalModal(editId) {
  document.getElementById('goalModalTitle').textContent = editId ? 'Doel bewerken' : 'Nieuw doel';
  document.getElementById('goalEditId').value = editId || '';
  document.getElementById('milestonesContainer').innerHTML = '';

  if (editId) {
    const goal = await dbGet('goals', editId);
    if (!goal) return;
    document.getElementById('goalName').value = goal.name;
    document.getElementById('goalType').value = goal.type;
    document.getElementById('goalDeadline').value = goal.deadline || '';
    onGoalTypeChange();

    if (goal.type === 'total' && goal.metrics && goal.metrics[0]) {
      const m = goal.metrics[0];
      document.getElementById('goalTarget').value = m.target;
      document.getElementById('goalUnit').value = m.unit || 'uur';
      document.getElementById('goalSource').value = m.source;
      document.getElementById('goalSkillFilter').value = m.skillFilter || '';
    } else if (goal.type === 'recurring' && goal.metrics && goal.metrics[0]) {
      const m = goal.metrics[0];
      document.getElementById('goalRecurringTarget').value = m.recurringTarget || m.target;
      document.getElementById('goalRecurrence').value = m.recurrence || 'daily';
      document.getElementById('goalRecurringUnit').value = m.unit || 'min';
      document.getElementById('goalRecurringSource').value = m.source;
      document.getElementById('goalRecurringSkillFilter').value = m.skillFilter || '';
    } else if (goal.type === 'streak') {
      document.getElementById('goalStreakTarget').value = goal.metrics[0]?.target || 30;
      document.getElementById('goalStreakMinMinutes').value = goal.streakConfig?.minimumMinutes || 1;
      document.getElementById('goalStreakSkillFilter').value = goal.streakConfig?.skillFilter || '';
      document.getElementById('goalStreakPassiveToggle').classList.toggle('on', goal.streakConfig?.includePassive !== false);
    }

    // Color
    document.querySelectorAll('#goalColorPicker .tag-pill').forEach(p => {
      p.classList.toggle('selected', p.dataset.color === goal.color);
      if (p.dataset.color === goal.color) {
        p.style.background = `var(${goal.color.replace('--', '--') + (goal.color.includes('amber') ? '-glow' : '-dim')})`;
        p.style.borderColor = `var(${goal.color})`;
      }
    });

    // Milestones
    if (goal.milestones) {
      goal.milestones.forEach(ms => addMilestoneField(ms.label, ms.targetValue, ms.deadline));
    }
  } else {
    document.getElementById('goalName').value = '';
    document.getElementById('goalType').value = 'total';
    document.getElementById('goalTarget').value = '';
    document.getElementById('goalDeadline').value = '';
    document.getElementById('goalUnit').value = 'uur';
    document.getElementById('goalSource').value = 'auto_hours';
    document.getElementById('goalSkillFilter').value = '';
    onGoalTypeChange();
  }
  document.getElementById('goalModal').classList.add('show');
}

function closeGoalModal() {
  document.getElementById('goalModal').classList.remove('show');
}

function onGoalTypeChange() {
  const type = document.getElementById('goalType').value;
  document.getElementById('goalTotalFields').style.display = type === 'total' ? '' : 'none';
  document.getElementById('goalRecurringFields').style.display = type === 'recurring' ? '' : 'none';
  document.getElementById('goalStreakFields').style.display = type === 'streak' ? '' : 'none';
}

function addMilestoneField(label, value, deadline) {
  const container = document.getElementById('milestonesContainer');
  const div = document.createElement('div');
  div.className = 'milestone-field';
  div.innerHTML = `
    <input type="text" class="ms-label" placeholder="Naam" value="${label || ''}" style="font-family:'DM Sans',system-ui">
    <input type="number" class="ms-value" placeholder="Waarde" value="${value || ''}" style="width:80px">
    <input type="date" class="ms-deadline" value="${deadline || ''}" style="width:130px">
    <button class="milestone-remove" onclick="this.parentElement.remove()">&times;</button>
  `;
  container.appendChild(div);
}

function pickGoalColor(el) {
  document.querySelectorAll('#goalColorPicker .tag-pill').forEach(p => {
    p.classList.remove('selected');
    p.style.background = '';
    p.style.borderColor = '';
  });
  el.classList.add('selected');
  const color = el.dataset.color;
  el.style.borderColor = `var(${color})`;
}

async function saveGoal() {
  const editId = document.getElementById('goalEditId').value;
  const name = document.getElementById('goalName').value.trim();
  const type = document.getElementById('goalType').value;
  const deadline = document.getElementById('goalDeadline').value || null;

  if (!name) { showToast('Vul een naam in!'); return; }

  const colorEl = document.querySelector('#goalColorPicker .tag-pill.selected');
  const color = colorEl ? colorEl.dataset.color : '--amber';

  let metrics = [];
  let streakConfig = null;

  if (type === 'total') {
    const target = parseFloat(document.getElementById('goalTarget').value) || 0;
    const unit = document.getElementById('goalUnit').value;
    const source = document.getElementById('goalSource').value;
    const skillFilter = document.getElementById('goalSkillFilter').value || null;
    if (target <= 0) { showToast('Vul een doelwaarde in!'); return; }
    metrics = [{ id: 'main', label: name, unit, target, source, skillFilter, passiveFilter: 'all', recurrence: null, recurringTarget: null }];
  } else if (type === 'recurring') {
    const recurringTarget = parseFloat(document.getElementById('goalRecurringTarget').value) || 0;
    const recurrence = document.getElementById('goalRecurrence').value;
    const unit = document.getElementById('goalRecurringUnit').value;
    const source = document.getElementById('goalRecurringSource').value;
    const skillFilter = document.getElementById('goalRecurringSkillFilter').value || null;
    if (recurringTarget <= 0) { showToast('Vul een doelwaarde in!'); return; }
    metrics = [{ id: 'main', label: name, unit, target: recurringTarget, source, skillFilter, passiveFilter: 'all', recurrence, recurringTarget }];
  } else if (type === 'streak') {
    const target = parseInt(document.getElementById('goalStreakTarget').value) || 30;
    const minimumMinutes = parseInt(document.getElementById('goalStreakMinMinutes').value) || 1;
    const skillFilter = document.getElementById('goalStreakSkillFilter').value || null;
    const includePassive = document.getElementById('goalStreakPassiveToggle').classList.contains('on');
    metrics = [{ id: 'main', label: name, unit: 'dagen', target, source: 'auto_hours', skillFilter, passiveFilter: 'all', recurrence: null, recurringTarget: null }];
    streakConfig = { minimumMinutes, skillFilter, includePassive };
  }

  // Milestones
  const milestones = [...document.querySelectorAll('.milestone-field')].map(div => ({
    id: genId(),
    label: div.querySelector('.ms-label').value.trim(),
    targetValue: parseFloat(div.querySelector('.ms-value').value) || 0,
    deadline: div.querySelector('.ms-deadline').value || null,
    reachedAt: null
  })).filter(ms => ms.label && ms.targetValue > 0);

  const goal = {
    id: editId || genId(),
    name,
    type,
    status: 'active',
    createdAt: Date.now(),
    metrics,
    deadline,
    milestones,
    streakConfig,
    color,
    icon: type === 'streak' ? 'üî•' : 'üéØ',
    pinToDashboard: true,
    sortOrder: 0
  };

  if (editId) {
    const existing = await dbGet('goals', editId);
    if (existing) {
      goal.createdAt = existing.createdAt;
      goal.sortOrder = existing.sortOrder;
    }
  }

  await dbPut('goals', goal);
  showToast(editId ? 'Doel bijgewerkt!' : 'Doel aangemaakt!');
  closeGoalModal();
  refreshAll();
}

async function archiveGoal(id) {
  if (!confirm('Dit doel archiveren?')) return;
  const goal = await dbGet('goals', id);
  if (!goal) return;
  goal.status = 'archived';
  await dbPut('goals', goal);
  showToast('Doel gearchiveerd');
  showUndo('Doel gearchiveerd', async () => {
    goal.status = 'active';
    await dbPut('goals', goal);
    refreshAll();
  });
  refreshAll();
}

async function deleteGoal(id) {
  if (!confirm('Dit doel definitief verwijderen?')) return;
  const goal = await dbGet('goals', id);
  await dbDelete('goals', id);
  showToast('Doel verwijderd');
  showUndo('Doel verwijderd', () => dbPut('goals', goal));
  refreshAll();
}

// ‚îÄ‚îÄ Goal Progress Update ‚îÄ‚îÄ
function openGoalProgressModal(goalId, metricId, label) {
  document.getElementById('goalProgressGoalId').value = goalId;
  document.getElementById('goalProgressMetricId').value = metricId;
  document.getElementById('goalProgressLabel').textContent = label;
  document.getElementById('goalProgressDate').value = today();
  document.getElementById('goalProgressValue').value = '';
  document.getElementById('goalProgressTitle').textContent = 'Voortgang: ' + label;
  document.getElementById('goalProgressModal').classList.add('show');
}

function closeGoalProgressModal() {
  document.getElementById('goalProgressModal').classList.remove('show');
}

async function saveGoalProgress() {
  const goalId = document.getElementById('goalProgressGoalId').value;
  const metricId = document.getElementById('goalProgressMetricId').value;
  const date = document.getElementById('goalProgressDate').value;
  const value = parseFloat(document.getElementById('goalProgressValue').value) || 0;
  if (!date || value <= 0) { showToast('Vul datum en waarde in!'); return; }
  const entry = { id: `${goalId}_${metricId}_${date}_${Date.now()}`, goalId, metricId, date, value, timestamp: Date.now() };
  await dbPut('goal_progress', entry);
  showToast('Voortgang opgeslagen!');
  closeGoalProgressModal();
  refreshAll();
}

// ‚îÄ‚îÄ Default Goal Migration ‚îÄ‚îÄ
async function migrateExistingGoals() {
  try {
    const migrated = await dbGet('settings', 'goals_migrated_v3');
    if (migrated) return;
    const thg = await dbGet('settings', 'totalHourGoal');
    const targetHours = thg ? thg.value : 500;
    const defaultGoal = {
      id: 'b1_exam_legacy',
      name: 'B1 Examen',
      type: 'total',
      status: 'active',
      createdAt: Date.now(),
      metrics: [{ id: 'hours', label: 'Studie-uren', unit: 'uur', target: targetHours, source: 'auto_hours', skillFilter: null, passiveFilter: 'all', recurrence: null, recurringTarget: null }],
      deadline: '2026-05-10',
      milestones: [],
      streakConfig: null,
      color: '--amber',
      icon: 'üéØ',
      pinToDashboard: true,
      sortOrder: 0
    };
    await dbPut('goals', defaultGoal);
    await dbPut('settings', { key: 'goals_migrated_v3', value: true });
  } catch(e) { console.log('Goal migration skipped:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSettings() {
  try {
    const theme = await dbGet('settings', 'theme');
    if (theme && theme.value === 'light') {
      document.documentElement.classList.add('light-mode');
      document.getElementById('themeToggle').textContent = 'üåô';
      document.getElementById('darkToggle').classList.remove('on');
    } else {
      document.getElementById('darkToggle').classList.add('on');
    }
    const goal = await dbGet('settings', 'hourGoal');
    if (goal) { hourGoal = goal.value; document.getElementById('goalInput').value = hourGoal; }
    const extend = await dbGet('settings', 'extendDay');
    if (extend && extend.value) {
      extendDayPastMidnight = true;
      document.getElementById('extendDayToggle').classList.add('on');
    }
  } catch(e) {}
}

function toggleTheme() {
  const isLight = document.documentElement.classList.toggle('light-mode');
  document.getElementById('themeToggle').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
  const toggle = document.getElementById('darkToggle');
  if (isLight) toggle.classList.remove('on'); else toggle.classList.add('on');
  dbPut('settings', { key: 'theme', value: isLight ? 'light' : 'dark' });
  // Redraw charts if on stats tab
  if (document.getElementById('viewStats').classList.contains('active')) refreshStats();
}

function updateGoal(val) {
  hourGoal = parseFloat(val) || 2;
  dbPut('settings', { key: 'hourGoal', value: hourGoal });
  refreshAll();
}

function toggleExtendDay() {
  extendDayPastMidnight = !extendDayPastMidnight;
  const toggle = document.getElementById('extendDayToggle');
  if (extendDayPastMidnight) toggle.classList.add('on'); else toggle.classList.remove('on');
  dbPut('settings', { key: 'extendDay', value: extendDayPastMidnight });
  refreshAll();
}

// ‚îÄ‚îÄ Export / Import / Reset ‚îÄ‚îÄ
async function exportData() {
  const logs = await dbGetAll('logs');
  const anki = await dbGetAll('anki');
  let goals = [], goalProgress = [];
  try { goals = await dbGetAll('goals'); } catch(e) {}
  try { goalProgress = await dbGetAll('goal_progress'); } catch(e) {}
  const data = JSON.stringify({ logs, anki, goals, goal_progress: goalProgress, version: 3, exported: new Date().toISOString() }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dutch-tracker-backup-${today()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Gegevens ge√´xporteerd!');
}

function importData() {
  document.getElementById('fileImport').click();
}

async function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (data.logs) { await dbClear('logs'); for (const l of data.logs) { delete l.id; await dbPut('logs', l); } }
    if (data.anki) { await dbClear('anki'); for (const a of data.anki) { delete a.id; await dbPut('anki', a); } }
    if (data.goals) { await dbClear('goals'); for (const g of data.goals) { await dbPut('goals', g); } }
    if (data.goal_progress) { await dbClear('goal_progress'); for (const p of data.goal_progress) { await dbPut('goal_progress', p); } }
    // Silently skip vocab from old v2 exports
    showToast('Gegevens ge√Ømporteerd!');
    refreshAll();
  } catch(err) {
    showToast('Fout bij importeren!');
  }
  e.target.value = '';
}

async function resetData() {
  if (!confirm('Alle gegevens wissen? Dit kan niet ongedaan worden!')) return;
  if (!confirm('Weet je het zeker? Alle studie-data wordt verwijderd.')) return;
  await dbClear('logs');
  await dbClear('anki');
  try { await dbClear('goals'); } catch(e) {}
  try { await dbClear('goal_progress'); } catch(e) {}
  await dbPut('settings', { key: 'goals_migrated_v3', value: false });
  await migrateExistingGoals();
  showToast('Alle gegevens gewist');
  refreshAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REFRESH ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshAll() {
  refreshDashboard();
  if (document.getElementById('viewStats').classList.contains('active')) refreshStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  await openDB();
  await loadSettings();
  await migrateExistingGoals();
  refreshDashboard();

  // Set default dates
  document.getElementById('manualDate').value = today();
  document.getElementById('ankiDate').value = today();

  // Show passive toggle if listening is default
  onSkillChange();
  onTimerSkillChange();

  // Register service worker
  if ('serviceWorker' in navigator) {
    let refreshed = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshed) return;
      refreshed = true;
      location.reload();
    });

    navigator.serviceWorker.register('sw.js?v=5', { updateViaCache: 'none' }).then(reg => {
      reg.update().catch(() => {});
      if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
      reg.addEventListener('updatefound', () => {
        const worker = reg.installing;
        if (!worker) return;
        worker.addEventListener('statechange', () => {
          if (worker.state === 'installed' && navigator.serviceWorker.controller) {
            worker.postMessage('SKIP_WAITING');
          }
        });
      });
    }).catch(() => {});
  }
}

init();
</script>
</body>
</html>
